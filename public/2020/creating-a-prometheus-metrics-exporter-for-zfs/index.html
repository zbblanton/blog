<!DOCTYPE html>
<html lang="en-us">
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Blanton Technology  | Creating a Prometheus Metrics Exporter for ZFS</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.7.1/css/bulma.min.css" />
    <link rel="stylesheet" href="http:///blantontechnology.com/css/blog.css" />
    
</head>
<body>

    
    <nav class="navbar is-fixed-top" role="navigation" aria-label="main navigation">
        <div class="navbar-brand">
            <a class="navbar-item" href="http:///blantontechnology.com">Home</a>
            
            <a class="navbar-item" href="https://www.linkedin.com/in/zacharyblanton/">About</a>            
        </div>
    </nav>
    

    
    <section class="hero is-info is-medium">
        <div class="hero-body" style="background-image: url(http:///blantontechnology.com/img/bg-blog.jpg);">
            <div class="container has-text-centered">
                <br>
                <h1 class="title is-size-1">
                    
                        Creating a Prometheus Metrics Exporter for ZFS
                    
                </h1>
                
                    May 30, 2020 &middot;&nbsp;10 min read
                
            </div>
        </div>
    </section>


<div class="container">
    <div class="section">
    

<div class="columns">
    <div class="column is-9">
        <div class="tile is-child box">
            <div class="content">
                <h1 id="creating-a-prometheus-exporter-for-proxmox-zfs">Creating a Prometheus Exporter for Proxmox ZFS</h1>
<p>I&rsquo;m starting to get into monitoring with Prometheus and Alertmanager. One of the first things I want to start monitoring is ZFS on my Proxmox server. I noticed that there isn&rsquo;t many exporters to scrape ZFS information so I decided to figure out how to create an exporter that can I can then use to monitor my ZFS zpools.</p>
<p>The source code for the end result is here: <a href="https://github.com/zbblanton/proxmox-zfs-exporter">https://github.com/zbblanton/proxmox-zfs-exporter</a></p>
<p>I&rsquo;m going to try a different format for this post and try to write it as I create the exporter.</p>
<p>So what I want is to create an exporter that prometheus can scrape that contains the current zpool state, if there are errors, the last scan time, and number of scan errors for each zpool.</p>
<p>Lets start by doing some research and I won&rsquo;t lie I already did some before I decided to write this post. Heres what I know so far:</p>
<ul>
<li>proxmox provides a pretty good API to use that gives me the information about zfs that I need.</li>
<li>proxmox requires a &ldquo;ticket&rdquo; to authentication to the API as a cookie. You have to do a post request with some proxmox credentials to receive a payload with the ticket.</li>
</ul>
<p>To create an authentication &ldquo;ticket&rdquo; we need to do a request. The Proxmox API documentation used curl in their example:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">curl -k -d <span style="color:#f1fa8c">&#34;username=root@pam&amp;password=yourpassword&#34;</span>  https://10.0.0.1:8006/api2/json/access/ticket 
</code></pre></div><p>Which returned:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{ 
    <span style="color:#ff79c6">&#34;data&#34;</span>: { 
        <span style="color:#ff79c6">&#34;CSRFPreventionToken&#34;</span>:<span style="color:#f1fa8c">&#34;4EEC61E2:lwk7od06fa1+DcPUwBTXCcndyAY&#34;</span>,  
        <span style="color:#ff79c6">&#34;ticket&#34;</span>:<span style="color:#f1fa8c">&#34;PVE:root@pam:4EEC61E2::rsKoApxDTLYPn6H3NNT6iP2mv...&#34;</span>, 
        <span style="color:#ff79c6">&#34;username&#34;</span>:<span style="color:#f1fa8c">&#34;root@pam&#34;</span>
    }
}
</code></pre></div><p>Source: <a href="https://pve.proxmox.com/wiki/Proxmox_VE_API#Authentication">https://pve.proxmox.com/wiki/Proxmox_VE_API#Authentication</a></p>
<p>I opened Postman and grabbed the <code>ticket</code> from the response and created a cookie called <code>PVEAuthCookie</code> with the value set to the ticket.</p>
<p><img src="http:///blantontechnology.com/img/postman.png" alt="Postman"></p>
<p>Looking through the <a href="https://pve.proxmox.com/pve-docs/api-viewer/index.html">API explorer</a> I got an idea of the calls I want to make. So with postman I created a GET request to <code>https://10.0.0.20:8006/api2/json/nodes/pve/disks/zfs</code> and got back my zpools:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
    <span style="color:#ff79c6">&#34;data&#34;</span>: [
        {
            <span style="color:#ff79c6">&#34;size&#34;</span>: <span style="color:#bd93f9">2989297238016</span>,
            <span style="color:#ff79c6">&#34;name&#34;</span>: <span style="color:#f1fa8c">&#34;storage&#34;</span>,
            <span style="color:#ff79c6">&#34;dedup&#34;</span>: <span style="color:#bd93f9">1</span>,
            <span style="color:#ff79c6">&#34;alloc&#34;</span>: <span style="color:#bd93f9">895623524352</span>,
            <span style="color:#ff79c6">&#34;health&#34;</span>: <span style="color:#f1fa8c">&#34;ONLINE&#34;</span>,
            <span style="color:#ff79c6">&#34;free&#34;</span>: <span style="color:#bd93f9">2093673713664</span>,
            <span style="color:#ff79c6">&#34;frag&#34;</span>: <span style="color:#bd93f9">1</span>
        },
        {
            <span style="color:#ff79c6">&#34;size&#34;</span>: <span style="color:#bd93f9">255550554112</span>,
            <span style="color:#ff79c6">&#34;alloc&#34;</span>: <span style="color:#bd93f9">1351680</span>,
            <span style="color:#ff79c6">&#34;health&#34;</span>: <span style="color:#f1fa8c">&#34;ONLINE&#34;</span>,
            <span style="color:#ff79c6">&#34;name&#34;</span>: <span style="color:#f1fa8c">&#34;storage-nvme&#34;</span>,
            <span style="color:#ff79c6">&#34;dedup&#34;</span>: <span style="color:#bd93f9">1</span>,
            <span style="color:#ff79c6">&#34;free&#34;</span>: <span style="color:#bd93f9">255549202432</span>,
            <span style="color:#ff79c6">&#34;frag&#34;</span>: <span style="color:#bd93f9">0</span>
        }
    ]
}
</code></pre></div><p>Knowing this, I can loop through all my zpools and get more information on the zpool by calling <code>https://10.0.0.20:8006/api2/json/nodes/pve/disks/zfs/storage</code> where <code>storage</code> is the name of one of my zpools. This returns:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
    <span style="color:#ff79c6">&#34;data&#34;</span>: {
        <span style="color:#ff79c6">&#34;scan&#34;</span>: <span style="color:#f1fa8c">&#34;scrub repaired 0B in 0 days 01:56:29 with 0 errors on Sun May 10 02:20:30 2020&#34;</span>,
        <span style="color:#ff79c6">&#34;errors&#34;</span>: <span style="color:#f1fa8c">&#34;No known data errors&#34;</span>,
        <span style="color:#ff79c6">&#34;leaf&#34;</span>: <span style="color:#bd93f9">0</span>,
        <span style="color:#ff79c6">&#34;action&#34;</span>: <span style="color:#f1fa8c">&#34;Enable all features using &#39;zpool upgrade&#39;. Once this is done, the pool may no longer be accessible by software that does not support the features. See zpool-features(5) for details.&#34;</span>,
        <span style="color:#ff79c6">&#34;children&#34;</span>: [
            {
                <span style="color:#ff79c6">&#34;state&#34;</span>: <span style="color:#f1fa8c">&#34;ONLINE&#34;</span>,
                <span style="color:#ff79c6">&#34;children&#34;</span>: [
                    {
                        <span style="color:#ff79c6">&#34;cksum&#34;</span>: <span style="color:#bd93f9">0</span>,
                        <span style="color:#ff79c6">&#34;name&#34;</span>: <span style="color:#f1fa8c">&#34;/dev/sdb2&#34;</span>,
                        <span style="color:#ff79c6">&#34;msg&#34;</span>: <span style="color:#f1fa8c">&#34;&#34;</span>,
                        <span style="color:#ff79c6">&#34;read&#34;</span>: <span style="color:#bd93f9">0</span>,
                        <span style="color:#ff79c6">&#34;write&#34;</span>: <span style="color:#bd93f9">0</span>,
                        <span style="color:#ff79c6">&#34;leaf&#34;</span>: <span style="color:#bd93f9">1</span>,
                        <span style="color:#ff79c6">&#34;state&#34;</span>: <span style="color:#f1fa8c">&#34;ONLINE&#34;</span>
                    },
                    {
                        <span style="color:#ff79c6">&#34;msg&#34;</span>: <span style="color:#f1fa8c">&#34;&#34;</span>,
                        <span style="color:#ff79c6">&#34;name&#34;</span>: <span style="color:#f1fa8c">&#34;/dev/sdc2&#34;</span>,
                        <span style="color:#ff79c6">&#34;cksum&#34;</span>: <span style="color:#bd93f9">0</span>,
                        <span style="color:#ff79c6">&#34;state&#34;</span>: <span style="color:#f1fa8c">&#34;ONLINE&#34;</span>,
                        <span style="color:#ff79c6">&#34;leaf&#34;</span>: <span style="color:#bd93f9">1</span>,
                        <span style="color:#ff79c6">&#34;write&#34;</span>: <span style="color:#bd93f9">0</span>,
                        <span style="color:#ff79c6">&#34;read&#34;</span>: <span style="color:#bd93f9">0</span>
                    }
                ],
                <span style="color:#ff79c6">&#34;name&#34;</span>: <span style="color:#f1fa8c">&#34;mirror-0&#34;</span>,
                <span style="color:#ff79c6">&#34;cksum&#34;</span>: <span style="color:#bd93f9">0</span>,
                <span style="color:#ff79c6">&#34;leaf&#34;</span>: <span style="color:#bd93f9">0</span>,
                <span style="color:#ff79c6">&#34;write&#34;</span>: <span style="color:#bd93f9">0</span>,
                <span style="color:#ff79c6">&#34;read&#34;</span>: <span style="color:#bd93f9">0</span>,
                <span style="color:#ff79c6">&#34;msg&#34;</span>: <span style="color:#f1fa8c">&#34;&#34;</span>
            }
        ],
        <span style="color:#ff79c6">&#34;state&#34;</span>: <span style="color:#f1fa8c">&#34;ONLINE&#34;</span>,
        <span style="color:#ff79c6">&#34;name&#34;</span>: <span style="color:#f1fa8c">&#34;storage&#34;</span>,
        <span style="color:#ff79c6">&#34;status&#34;</span>: <span style="color:#f1fa8c">&#34;Some supported features are not enabled on the pool. The pool can still be used, but some features are unavailable.&#34;</span>
    }
}
</code></pre></div><p>Ignore the supported feature information. That is from me moving my disks to another machine and not doing a zpool upgrade yet.</p>
<p>Now I need to figure out how to create a cookie in a go http request so that I can authenticate to the proxmox API. After some searching, I found it to be pretty simple with the http package: <a href="https://golang.org/pkg/net/http/#Request.AddCookie">https://golang.org/pkg/net/http/#Request.AddCookie</a>. I can create a request and then use the <code>AddCookie</code> function:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">url <span style="color:#ff79c6">:=</span> <span style="color:#f1fa8c">&#34;https://api.cloudflare.com/client/v4/zones/&#34;</span> <span style="color:#ff79c6">+</span> c.ZoneID <span style="color:#ff79c6">+</span> <span style="color:#f1fa8c">&#34;/dns_records?type=TXT&#34;</span>
<span style="color:#6272a4">//fmt.Println(url)
</span><span style="color:#6272a4"></span>client <span style="color:#ff79c6">:=</span> <span style="color:#ff79c6">&amp;</span>http.Client{}
req, err <span style="color:#ff79c6">:=</span> http.<span style="color:#50fa7b">NewRequest</span>(<span style="color:#f1fa8c">&#34;GET&#34;</span>, url, <span style="color:#ff79c6">nil</span>)
<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		<span style="color:#ff79c6">return</span> []CloudflareRecord{}, err
    }
cookie <span style="color:#ff79c6">:=</span> http.Cookie{
    Name: <span style="color:#f1fa8c">&#34;test&#34;</span>
    Value: <span style="color:#f1fa8c">&#34;test&#34;</span>
}
req.<span style="color:#50fa7b">AddCookie</span>(<span style="color:#ff79c6">&amp;</span>cookie)
</code></pre></div><p>I can start playing with some code now. I&rsquo;ll create a struct for the Proxmox API and then add some functions to it for calling the API.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#8be9fd;font-style:italic">type</span> ProxmoxAPI <span style="color:#8be9fd;font-style:italic">struct</span> {
	User   <span style="color:#8be9fd">string</span>
	Pass   <span style="color:#8be9fd">string</span>
	Host   <span style="color:#8be9fd">string</span>
	Port   <span style="color:#8be9fd">string</span>
	Ticket <span style="color:#8be9fd">string</span>
	mux    sync.Mutex
}
</code></pre></div><p>I need the mutex in the struct because multiple go routines could be accessing the same <code>ProxmoxAPI</code> struct.</p>
<p>A note from the Proxmox documentation said that the <code>ticket</code> will expire every two hours. So I need to write some code that will grab a new ticket every one hour to be safe.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#8be9fd;font-style:italic">type</span> ProxmoxAPITicketResp <span style="color:#8be9fd;font-style:italic">struct</span> {
	Data <span style="color:#8be9fd;font-style:italic">struct</span> {
		CSRFPreventionToken <span style="color:#8be9fd">string</span> <span style="color:#f1fa8c">`json:&#34;CSRFPreventionToken&#34;`</span>
		Ticket              <span style="color:#8be9fd">string</span> <span style="color:#f1fa8c">`json:&#34;ticket&#34;`</span>
		Username            <span style="color:#8be9fd">string</span> <span style="color:#f1fa8c">`json:&#34;username&#34;`</span>
	} <span style="color:#f1fa8c">`json:&#34;data&#34;`</span>
}

<span style="color:#8be9fd;font-style:italic">func</span> (api <span style="color:#ff79c6">*</span>ProxmoxAPI) <span style="color:#50fa7b">getTicket</span>() <span style="color:#8be9fd">string</span> {
	api.mux.<span style="color:#50fa7b">Lock</span>()
	<span style="color:#ff79c6">defer</span> api.mux.<span style="color:#50fa7b">Unlock</span>()
	<span style="color:#ff79c6">return</span> api.Ticket
}

<span style="color:#8be9fd;font-style:italic">func</span> (api <span style="color:#ff79c6">*</span>ProxmoxAPI) <span style="color:#50fa7b">setTicket</span>(ticket <span style="color:#8be9fd">string</span>) {
	api.mux.<span style="color:#50fa7b">Lock</span>()
	api.Ticket = ticket
	api.mux.<span style="color:#50fa7b">Unlock</span>()
}

<span style="color:#8be9fd;font-style:italic">func</span> (api <span style="color:#ff79c6">*</span>ProxmoxAPI) <span style="color:#50fa7b">GetAPITicket</span>() (<span style="color:#8be9fd">string</span>, <span style="color:#8be9fd">error</span>) {
	<span style="color:#6272a4">//Copy the api vars so we can free the lock up
</span><span style="color:#6272a4"></span>	api.mux.<span style="color:#50fa7b">Lock</span>()
	user <span style="color:#ff79c6">:=</span> api.User
	pass <span style="color:#ff79c6">:=</span> api.Pass
	host <span style="color:#ff79c6">:=</span> api.Host
	port <span style="color:#ff79c6">:=</span> api.Port
	api.mux.<span style="color:#50fa7b">Unlock</span>()

	url <span style="color:#ff79c6">:=</span> <span style="color:#f1fa8c">&#34;https://&#34;</span> <span style="color:#ff79c6">+</span> host <span style="color:#ff79c6">+</span> <span style="color:#f1fa8c">&#34;:&#34;</span> <span style="color:#ff79c6">+</span> port <span style="color:#ff79c6">+</span> <span style="color:#f1fa8c">&#34;/api2/json/access/ticket?username=&#34;</span> <span style="color:#ff79c6">+</span> user <span style="color:#ff79c6">+</span> <span style="color:#f1fa8c">&#34;&amp;password=&#34;</span> <span style="color:#ff79c6">+</span> pass
	c <span style="color:#ff79c6">:=</span> <span style="color:#ff79c6">&amp;</span>tls.Config{
		InsecureSkipVerify: <span style="color:#ff79c6">true</span>,
	}
	tr <span style="color:#ff79c6">:=</span> <span style="color:#ff79c6">&amp;</span>http.Transport{TLSClientConfig: c}
	client <span style="color:#ff79c6">:=</span> <span style="color:#ff79c6">&amp;</span>http.Client{Transport: tr}
	<span style="color:#6272a4">//client := &amp;http.Client{}
</span><span style="color:#6272a4"></span>	req, err <span style="color:#ff79c6">:=</span> http.<span style="color:#50fa7b">NewRequest</span>(<span style="color:#f1fa8c">&#34;POST&#34;</span>, url, <span style="color:#ff79c6">nil</span>)
	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		<span style="color:#ff79c6">return</span> <span style="color:#f1fa8c">&#34;&#34;</span>, err
	}
	req.Header.<span style="color:#50fa7b">Add</span>(<span style="color:#f1fa8c">&#34;Content-type&#34;</span>, <span style="color:#f1fa8c">&#34;application/json&#34;</span>)

	resp, err <span style="color:#ff79c6">:=</span> client.<span style="color:#50fa7b">Do</span>(req)
	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		<span style="color:#ff79c6">return</span> <span style="color:#f1fa8c">&#34;&#34;</span>, err
	}
	<span style="color:#ff79c6">defer</span> resp.Body.<span style="color:#50fa7b">Close</span>() <span style="color:#6272a4">//Close the resp body when finished
</span><span style="color:#6272a4"></span>
	respBody <span style="color:#ff79c6">:=</span> ProxmoxAPITicketResp{}
	err = json.<span style="color:#50fa7b">NewDecoder</span>(resp.Body).<span style="color:#50fa7b">Decode</span>(<span style="color:#ff79c6">&amp;</span>respBody)
	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		<span style="color:#ff79c6">return</span> <span style="color:#f1fa8c">&#34;&#34;</span>, err
	}

	<span style="color:#ff79c6">return</span> respBody.Data.Ticket, <span style="color:#ff79c6">nil</span>
}

<span style="color:#8be9fd;font-style:italic">func</span> (api <span style="color:#ff79c6">*</span>ProxmoxAPI) <span style="color:#50fa7b">refreshTicket</span>() {
	ticker <span style="color:#ff79c6">:=</span> time.<span style="color:#50fa7b">NewTicker</span>(time.Hour)
	<span style="color:#ff79c6">for</span> {
		newTicket, err <span style="color:#ff79c6">:=</span> api.<span style="color:#50fa7b">GetAPITicket</span>()
		<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
			fmt.<span style="color:#50fa7b">Println</span>(<span style="color:#f1fa8c">&#34;Could not retrieve new ticket. Retry on next check...&#34;</span>)
		}
		api.<span style="color:#50fa7b">setTicket</span>(newTicket)
		fmt.<span style="color:#50fa7b">Println</span>(<span style="color:#f1fa8c">&#34;Refreshed ticket&#34;</span>)
		<span style="color:#ff79c6">&lt;-</span>ticker.C
	}
}
</code></pre></div><p>Next, I need to figure out some best practices on creating an exporter. Some really good information from the docs for <a href="https://prometheus.io/docs/instrumenting/writing_exporters/#scheduling">prometheus</a> is that the metrics should only be pulled when being scrape by Prometheus and not use its own timer. Which means anytime the <code>/metrics</code> endpoint is hit, the metrics should be scraped and then returned. This changes how I was originally planning to get metrics by caching the values and then letting the endpoint handler pulling the values (Which by the way, in the docs it says caching is okay but only if it&rsquo;s expensive to scrape on each request). After some more searching around I come along this really good tutorial: <a href="https://rsmitty.github.io/Prometheus-Exporters/">https://rsmitty.github.io/Prometheus-Exporters/</a>. The article says I need to create a collector that implements the Prometheus collector interface. To do this I need to implement the <code>Describe</code> and <code>Collect</code> method.</p>
<p>To start I need to create all the metric descriptors, which is simply some metadata for each metric.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#8be9fd;font-style:italic">var</span> (
	zpoolError = prometheus.<span style="color:#50fa7b">NewDesc</span>(
		<span style="color:#f1fa8c">&#34;zfs_zpool_error&#34;</span>,
		<span style="color:#f1fa8c">&#34;Is there a zpool error&#34;</span>,
		[]<span style="color:#8be9fd">string</span>{<span style="color:#f1fa8c">&#34;node&#34;</span>, <span style="color:#f1fa8c">&#34;name&#34;</span>},
		<span style="color:#ff79c6">nil</span>,
	)
	zpoolOnline = prometheus.<span style="color:#50fa7b">NewDesc</span>(
		<span style="color:#f1fa8c">&#34;zfs_zpool_online&#34;</span>,
		<span style="color:#f1fa8c">&#34;Is the zpool online&#34;</span>,
		[]<span style="color:#8be9fd">string</span>{<span style="color:#f1fa8c">&#34;node&#34;</span>, <span style="color:#f1fa8c">&#34;name&#34;</span>},
		<span style="color:#ff79c6">nil</span>,
	)
	zpoolFree = prometheus.<span style="color:#50fa7b">NewDesc</span>(
		<span style="color:#f1fa8c">&#34;zfs_zpool_free&#34;</span>,
		<span style="color:#f1fa8c">&#34;Free space on zpool&#34;</span>,
		[]<span style="color:#8be9fd">string</span>{<span style="color:#f1fa8c">&#34;node&#34;</span>, <span style="color:#f1fa8c">&#34;name&#34;</span>},
		<span style="color:#ff79c6">nil</span>,
	)
	zpoolAllocated = prometheus.<span style="color:#50fa7b">NewDesc</span>(
		<span style="color:#f1fa8c">&#34;zfs_zpool_allocated&#34;</span>,
		<span style="color:#f1fa8c">&#34;Allocated space on zpool&#34;</span>,
		[]<span style="color:#8be9fd">string</span>{<span style="color:#f1fa8c">&#34;node&#34;</span>, <span style="color:#f1fa8c">&#34;name&#34;</span>},
		<span style="color:#ff79c6">nil</span>,
	)
	zpoolSize = prometheus.<span style="color:#50fa7b">NewDesc</span>(
		<span style="color:#f1fa8c">&#34;zfs_zpool_size&#34;</span>,
		<span style="color:#f1fa8c">&#34;Size of zpool&#34;</span>,
		[]<span style="color:#8be9fd">string</span>{<span style="color:#f1fa8c">&#34;node&#34;</span>, <span style="color:#f1fa8c">&#34;name&#34;</span>},
		<span style="color:#ff79c6">nil</span>,
	)
	zpoolDedup = prometheus.<span style="color:#50fa7b">NewDesc</span>(
		<span style="color:#f1fa8c">&#34;zfs_zpool_dedup&#34;</span>,
		<span style="color:#f1fa8c">&#34;Is dedup enabled on zpool&#34;</span>,
		[]<span style="color:#8be9fd">string</span>{<span style="color:#f1fa8c">&#34;node&#34;</span>, <span style="color:#f1fa8c">&#34;name&#34;</span>},
		<span style="color:#ff79c6">nil</span>,
	)
	zpoolLastScrub = prometheus.<span style="color:#50fa7b">NewDesc</span>(
		<span style="color:#f1fa8c">&#34;zfs_zpool_last_scrub&#34;</span>,
		<span style="color:#f1fa8c">&#34;Last zpool scrub&#34;</span>,
		[]<span style="color:#8be9fd">string</span>{<span style="color:#f1fa8c">&#34;node&#34;</span>, <span style="color:#f1fa8c">&#34;name&#34;</span>},
		<span style="color:#ff79c6">nil</span>,
	)
	zpoolLastScrubErrors = prometheus.<span style="color:#50fa7b">NewDesc</span>(
		<span style="color:#f1fa8c">&#34;zfs_zpool_last_scrub_errors&#34;</span>,
		<span style="color:#f1fa8c">&#34;Last scrub total errors on the zpool&#34;</span>,
		[]<span style="color:#8be9fd">string</span>{<span style="color:#f1fa8c">&#34;node&#34;</span>, <span style="color:#f1fa8c">&#34;name&#34;</span>},
		<span style="color:#ff79c6">nil</span>,
	)
	zpoolParsingError = prometheus.<span style="color:#50fa7b">NewDesc</span>(
		<span style="color:#f1fa8c">&#34;zfs_zpool_parsing_error&#34;</span>,
		<span style="color:#f1fa8c">&#34;Error when trying to parse the API data.&#34;</span>,
		[]<span style="color:#8be9fd">string</span>{<span style="color:#f1fa8c">&#34;node&#34;</span>, <span style="color:#f1fa8c">&#34;name&#34;</span>},
		<span style="color:#ff79c6">nil</span>,
	)
)
</code></pre></div><p>Implementing the <code>Describe</code> method is really easy. It&rsquo;s just a function that pushes each descriptor down the channel.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#8be9fd;font-style:italic">func</span> (collector <span style="color:#ff79c6">*</span>proxmoxZpoolCollector) <span style="color:#50fa7b">Describe</span>(ch <span style="color:#8be9fd;font-style:italic">chan</span><span style="color:#ff79c6">&lt;-</span> <span style="color:#ff79c6">*</span>prometheus.Desc) {
	ch <span style="color:#ff79c6">&lt;-</span> zpoolError
	ch <span style="color:#ff79c6">&lt;-</span> zpoolOnline
	ch <span style="color:#ff79c6">&lt;-</span> zpoolFree
	ch <span style="color:#ff79c6">&lt;-</span> zpoolAllocated
	ch <span style="color:#ff79c6">&lt;-</span> zpoolSize
	ch <span style="color:#ff79c6">&lt;-</span> zpoolDedup
	ch <span style="color:#ff79c6">&lt;-</span> zpoolLastScrub
	ch <span style="color:#ff79c6">&lt;-</span> zpoolLastScrubErrors
	ch <span style="color:#ff79c6">&lt;-</span> zpoolParsingError
}
</code></pre></div><p>The <code>Collect</code> is where you actually start doing some logic. I won&rsquo;t lie this function is pretty bad and needs to be broken up but here ya go:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#6272a4">//Needs to be split up
</span><span style="color:#6272a4"></span><span style="color:#8be9fd;font-style:italic">func</span> (collector <span style="color:#ff79c6">*</span>proxmoxZpoolCollector) <span style="color:#50fa7b">Collect</span>(ch <span style="color:#8be9fd;font-style:italic">chan</span><span style="color:#ff79c6">&lt;-</span> prometheus.Metric) {
	nodes, err <span style="color:#ff79c6">:=</span> collector.api.<span style="color:#50fa7b">GetNodes</span>()
	<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
		fmt.<span style="color:#50fa7b">Println</span>(err)
		<span style="color:#ff79c6">return</span>
	}
	<span style="color:#ff79c6">for</span> _, node <span style="color:#ff79c6">:=</span> <span style="color:#ff79c6">range</span> nodes.Data {
		zpoolList, err <span style="color:#ff79c6">:=</span> collector.api.<span style="color:#50fa7b">GetZpoolList</span>(node.Node)
		<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
			fmt.<span style="color:#50fa7b">Println</span>(err)
			<span style="color:#ff79c6">return</span>
		}
		<span style="color:#ff79c6">for</span> _, zpool <span style="color:#ff79c6">:=</span> <span style="color:#ff79c6">range</span> zpoolList.Data {
			<span style="color:#8be9fd;font-style:italic">var</span> zpoolParsingErrorMetric <span style="color:#8be9fd">float64</span>

			zpoolInfo, err <span style="color:#ff79c6">:=</span> collector.api.<span style="color:#50fa7b">GetZpool</span>(node.Node, zpool.Name)
			<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
				zpoolParsingErrorMetric = <span style="color:#8be9fd;font-style:italic">float64</span>(<span style="color:#bd93f9">1</span>)
				fmt.<span style="color:#50fa7b">Println</span>(err)
			}

			<span style="color:#8be9fd;font-style:italic">var</span> zpoolOnlineMetric <span style="color:#8be9fd">float64</span>
			<span style="color:#8be9fd;font-style:italic">var</span> zpoolErrorMetric <span style="color:#8be9fd">float64</span>
			<span style="color:#ff79c6">if</span> zpoolInfo.Data.State <span style="color:#ff79c6">==</span> <span style="color:#f1fa8c">&#34;ONLINE&#34;</span> {
				zpoolOnlineMetric = <span style="color:#8be9fd;font-style:italic">float64</span>(<span style="color:#bd93f9">1</span>)
				zpoolErrorMetric = <span style="color:#8be9fd;font-style:italic">float64</span>(<span style="color:#bd93f9">0</span>)
			} <span style="color:#ff79c6">else</span> {
				zpoolErrorMetric = <span style="color:#8be9fd;font-style:italic">float64</span>(<span style="color:#bd93f9">1</span>)
			}

			<span style="color:#8be9fd;font-style:italic">var</span> zpoolLastScrubMetric <span style="color:#8be9fd">float64</span>
			<span style="color:#6272a4">//Example scrub response: scrub repaired 0B in 0 days 01:56:29 with 0 errors on Sun May 10 02:20:30 2020
</span><span style="color:#6272a4"></span>			<span style="color:#ff79c6">if</span> x <span style="color:#ff79c6">:=</span> strings.<span style="color:#50fa7b">SplitAfter</span>(zpoolInfo.Data.Scan, <span style="color:#f1fa8c">&#34;on &#34;</span>); <span style="color:#8be9fd;font-style:italic">len</span>(x) <span style="color:#ff79c6">==</span> <span style="color:#bd93f9">2</span> {
				<span style="color:#6272a4">//Sun May 10 02:20:30 2020
</span><span style="color:#6272a4"></span>				<span style="color:#ff79c6">if</span> <span style="color:#8be9fd;font-style:italic">len</span>(x[<span style="color:#bd93f9">1</span>]) &gt; <span style="color:#bd93f9">5</span> { <span style="color:#6272a4">//We want to get rid of the day eg: Mon
</span><span style="color:#6272a4"></span>					<span style="color:#6272a4">//May 10 02:20:30 2020
</span><span style="color:#6272a4"></span>					t, err <span style="color:#ff79c6">:=</span> time.<span style="color:#50fa7b">Parse</span>(dateForm, x[<span style="color:#bd93f9">1</span>][<span style="color:#bd93f9">4</span>:])
					<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
						zpoolParsingErrorMetric = <span style="color:#8be9fd;font-style:italic">float64</span>(<span style="color:#bd93f9">1</span>)
						fmt.<span style="color:#50fa7b">Println</span>(err)
					}
					zpoolLastScrubMetric = <span style="color:#8be9fd;font-style:italic">float64</span>(t.<span style="color:#50fa7b">Unix</span>()) <span style="color:#6272a4">//Could this be an issue since time.Unix() returns int64?
</span><span style="color:#6272a4"></span>				}
			}

			<span style="color:#8be9fd;font-style:italic">var</span> zpoolLastScrubErrorsMetric <span style="color:#8be9fd">float64</span>
			<span style="color:#6272a4">//Example scrub response: scrub repaired 0B in 0 days 01:56:29 with 0 errors on Sun May 10 02:20:30 2020
</span><span style="color:#6272a4"></span>			splitLine <span style="color:#ff79c6">:=</span> strings.<span style="color:#50fa7b">Split</span>(zpoolInfo.Data.Scan, <span style="color:#f1fa8c">&#34; &#34;</span>)
			<span style="color:#ff79c6">for</span> index, x <span style="color:#ff79c6">:=</span> <span style="color:#ff79c6">range</span> splitLine {
				<span style="color:#ff79c6">if</span> strings.<span style="color:#50fa7b">Contains</span>(x, <span style="color:#f1fa8c">&#34;error&#34;</span>) <span style="color:#ff79c6">&amp;&amp;</span> index <span style="color:#ff79c6">&gt;=</span> <span style="color:#bd93f9">1</span> { <span style="color:#6272a4">//Support for &#34;error&#34; or &#34;errors&#34;
</span><span style="color:#6272a4"></span>					totalErrors, err <span style="color:#ff79c6">:=</span> strconv.<span style="color:#50fa7b">ParseFloat</span>(splitLine[index<span style="color:#ff79c6">-</span><span style="color:#bd93f9">1</span>], <span style="color:#bd93f9">64</span>) <span style="color:#6272a4">//We want to grab the number before error eg: 3 errors
</span><span style="color:#6272a4"></span>					<span style="color:#ff79c6">if</span> err <span style="color:#ff79c6">!=</span> <span style="color:#ff79c6">nil</span> {
						zpoolParsingErrorMetric = <span style="color:#8be9fd;font-style:italic">float64</span>(<span style="color:#bd93f9">1</span>)
					} <span style="color:#ff79c6">else</span> {
						zpoolLastScrubErrorsMetric = totalErrors
					}
					<span style="color:#ff79c6">break</span>
				}
			}

			ch <span style="color:#ff79c6">&lt;-</span> prometheus.<span style="color:#50fa7b">MustNewConstMetric</span>(zpoolError, prometheus.GaugeValue, zpoolErrorMetric, node.Node, zpool.Name)
			ch <span style="color:#ff79c6">&lt;-</span> prometheus.<span style="color:#50fa7b">MustNewConstMetric</span>(zpoolOnline, prometheus.GaugeValue, zpoolOnlineMetric, node.Node, zpool.Name)
			ch <span style="color:#ff79c6">&lt;-</span> prometheus.<span style="color:#50fa7b">MustNewConstMetric</span>(zpoolFree, prometheus.GaugeValue, zpool.Free, node.Node, zpool.Name)
			ch <span style="color:#ff79c6">&lt;-</span> prometheus.<span style="color:#50fa7b">MustNewConstMetric</span>(zpoolAllocated, prometheus.GaugeValue, zpool.Alloc, node.Node, zpool.Name)
			ch <span style="color:#ff79c6">&lt;-</span> prometheus.<span style="color:#50fa7b">MustNewConstMetric</span>(zpoolSize, prometheus.GaugeValue, zpool.Size, node.Node, zpool.Name)
			ch <span style="color:#ff79c6">&lt;-</span> prometheus.<span style="color:#50fa7b">MustNewConstMetric</span>(zpoolDedup, prometheus.GaugeValue, <span style="color:#8be9fd;font-style:italic">float64</span>(zpool.Dedup), node.Node, zpool.Name)
			ch <span style="color:#ff79c6">&lt;-</span> prometheus.<span style="color:#50fa7b">MustNewConstMetric</span>(zpoolLastScrub, prometheus.GaugeValue, zpoolLastScrubMetric, node.Node, zpool.Name)
			ch <span style="color:#ff79c6">&lt;-</span> prometheus.<span style="color:#50fa7b">MustNewConstMetric</span>(zpoolLastScrubErrors, prometheus.GaugeValue, zpoolLastScrubErrorsMetric, node.Node, zpool.Name)
			ch <span style="color:#ff79c6">&lt;-</span> prometheus.<span style="color:#50fa7b">MustNewConstMetric</span>(zpoolParsingError, prometheus.GaugeValue, zpoolParsingErrorMetric, node.Node, zpool.Name)
		}
	}
}
</code></pre></div><p>The main part here is at the end. For each metric, you just push it and it&rsquo;s value down the channel of the <code>Describe</code> function. Now I&rsquo;ve implemented the collector interface and have the Prometheus client do the rest of the work:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">newProxmoxZpoolCollector</span>(api <span style="color:#ff79c6">*</span>ProxmoxAPI) <span style="color:#ff79c6">*</span>proxmoxZpoolCollector {
	<span style="color:#ff79c6">return</span> <span style="color:#ff79c6">&amp;</span>proxmoxZpoolCollector{
		name: name,
		api:  api,
	}
}

<span style="color:#8be9fd;font-style:italic">func</span> <span style="color:#50fa7b">main</span>() {
	proxmoxAPI <span style="color:#ff79c6">:=</span> <span style="color:#50fa7b">readConfigFile</span>()
	collector <span style="color:#ff79c6">:=</span> <span style="color:#50fa7b">newProxmoxZpoolCollector</span>(proxmoxAPI)
	prometheus.<span style="color:#50fa7b">MustRegister</span>(collector)

	<span style="color:#ff79c6">go</span> proxmoxAPI.<span style="color:#50fa7b">refreshTicket</span>()
	<span style="color:#6272a4">//Wait for the first ticket to be set
</span><span style="color:#6272a4"></span>	proxmoxAPI.<span style="color:#50fa7b">waitForTicket</span>()

	http.<span style="color:#50fa7b">Handle</span>(<span style="color:#f1fa8c">&#34;/metrics&#34;</span>, promhttp.<span style="color:#50fa7b">Handler</span>())
	log.<span style="color:#50fa7b">Fatal</span>(http.<span style="color:#50fa7b">ListenAndServe</span>(<span style="color:#f1fa8c">&#34;:9000&#34;</span>, <span style="color:#ff79c6">nil</span>))
}
</code></pre></div><p>Now after building, I can goto to my browser and look at the metrics:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback"># TYPE promhttp_metric_handler_requests_total counter
promhttp_metric_handler_requests_total{code=&#34;200&#34;} 9590
promhttp_metric_handler_requests_total{code=&#34;500&#34;} 0
promhttp_metric_handler_requests_total{code=&#34;503&#34;} 0
# HELP zfs_zpool_allocated Allocated space on zpool
# TYPE zfs_zpool_allocated gauge
zfs_zpool_allocated{name=&#34;storage&#34;,node=&#34;pve&#34;} 8.95623524352e+11
zfs_zpool_allocated{name=&#34;storage-nvme&#34;,node=&#34;pve&#34;} 1.35168e+06
# HELP zfs_zpool_dedup Is dedup enabled on zpool
# TYPE zfs_zpool_dedup gauge
zfs_zpool_dedup{name=&#34;storage&#34;,node=&#34;pve&#34;} 1
zfs_zpool_dedup{name=&#34;storage-nvme&#34;,node=&#34;pve&#34;} 1
# HELP zfs_zpool_error Is there a zpool error
# TYPE zfs_zpool_error gauge
zfs_zpool_error{name=&#34;storage&#34;,node=&#34;pve&#34;} 0
zfs_zpool_error{name=&#34;storage-nvme&#34;,node=&#34;pve&#34;} 0
# HELP zfs_zpool_free Free space on zpool
# TYPE zfs_zpool_free gauge
zfs_zpool_free{name=&#34;storage&#34;,node=&#34;pve&#34;} 2.093673713664e+12
zfs_zpool_free{name=&#34;storage-nvme&#34;,node=&#34;pve&#34;} 2.55549202432e+11
# HELP zfs_zpool_last_scrub Last zpool scrub
# TYPE zfs_zpool_last_scrub gauge
zfs_zpool_last_scrub{name=&#34;storage&#34;,node=&#34;pve&#34;} 1.58907723e+09
zfs_zpool_last_scrub{name=&#34;storage-nvme&#34;,node=&#34;pve&#34;} 1.589070243e+09
# HELP zfs_zpool_last_scrub_errors Last scrub total errors on the zpool
# TYPE zfs_zpool_last_scrub_errors gauge
zfs_zpool_last_scrub_errors{name=&#34;storage&#34;,node=&#34;pve&#34;} 0
zfs_zpool_last_scrub_errors{name=&#34;storage-nvme&#34;,node=&#34;pve&#34;} 0
# HELP zfs_zpool_online Is the zpool online
# TYPE zfs_zpool_online gauge
zfs_zpool_online{name=&#34;storage&#34;,node=&#34;pve&#34;} 1
zfs_zpool_online{name=&#34;storage-nvme&#34;,node=&#34;pve&#34;} 1
# HELP zfs_zpool_parsing_error Error when trying to parse the API data.
# TYPE zfs_zpool_parsing_error gauge
zfs_zpool_parsing_error{name=&#34;storage&#34;,node=&#34;pve&#34;} 0
zfs_zpool_parsing_error{name=&#34;storage-nvme&#34;,node=&#34;pve&#34;} 0
# HELP zfs_zpool_size Size of zpool
# TYPE zfs_zpool_size gauge
zfs_zpool_size{name=&#34;storage&#34;,node=&#34;pve&#34;} 2.989297238016e+12
zfs_zpool_size{name=&#34;storage-nvme&#34;,node=&#34;pve&#34;} 2.55550554112e+11
</code></pre></div><p>Success! I now have metrics from the Proxmox API about my zfs zpools. To install the exporter on my Proxmox server I&rsquo;ll use systemd.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">wget https://github.com/zbblanton/proxmox-zfs-exporter/releases/download/v0.1.1/proxmox-zfs-exporter -O /usr/bin/proxmox-zfs-exporter
chmod +x /usr/bin/proxmox-zfs-exporter
cat &gt; /etc/systemd/system/proxmox-zfs-exporter.service <span style="color:#f1fa8c">&lt;&lt;EOF
</span><span style="color:#f1fa8c">[Unit]
</span><span style="color:#f1fa8c">Description=Proxmox ZFS Exporter
</span><span style="color:#f1fa8c">Documentation=https://github.com/zbblanton/proxmox-zfs-exporter
</span><span style="color:#f1fa8c">[Service]
</span><span style="color:#f1fa8c">ExecStart=/usr/bin/proxmox-zfs-exporter
</span><span style="color:#f1fa8c">Restart=on-failure
</span><span style="color:#f1fa8c">RestartSec=5
</span><span style="color:#f1fa8c">[Install]
</span><span style="color:#f1fa8c">WantedBy=multi-user.target
</span><span style="color:#f1fa8c">EOF</span>

systemctl daemon-reload
systemctl <span style="color:#8be9fd;font-style:italic">enable</span> proxmox-zfs-exporter
systemctl start proxmox-zfs-exporter
</code></pre></div><p>Note: I skipped the creation of the config file. If you&rsquo;re interested check out the git repo.</p>
<p>Lastly I can tell Prometheus to start scraping the new metrics endpoint and setup some alerts that will notify me if anything happens to my zpools.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">- <span style="color:#ff79c6">name</span>: monitoring
    <span style="color:#ff79c6">rules</span>:
    - <span style="color:#ff79c6">alert</span>: zpool_online
    <span style="color:#ff79c6">expr</span>: <span style="color:#f1fa8c">&#34;zfs_zpool_online != 1&#34;</span>
    <span style="color:#ff79c6">labels</span>:
        <span style="color:#ff79c6">severity</span>: high
    <span style="color:#ff79c6">annotations</span>:
        <span style="color:#ff79c6">summary</span>: <span style="color:#f1fa8c">&#34;State is not ONLINE for zpool: {{$labels.name}} on node: {{$labels.node}}&#34;</span>
        <span style="color:#ff79c6">description</span>: <span style="color:#f1fa8c">&#34;State is not ONLINE for zpool: {{$labels.name}} on node: {{$labels.node}}&#34;</span>
    - <span style="color:#ff79c6">alert</span>: zpool_low_space
    <span style="color:#ff79c6">expr</span>: <span style="color:#f1fa8c">&#34;zfs_zpool_free / zfs_zpool_size * 100 &lt;= 10&#34;</span>
    <span style="color:#ff79c6">labels</span>:
        <span style="color:#ff79c6">severity</span>: medium
    <span style="color:#ff79c6">annotations</span>:
        <span style="color:#ff79c6">summary</span>: <span style="color:#f1fa8c">&#34;Free space is at {{ .Value }}% for zpool: {{$labels.name}} on node: {{$labels.node}}&#34;</span>
        <span style="color:#ff79c6">description</span>: <span style="color:#f1fa8c">&#34;Free space is at {{ .Value }}% for zpool: {{$labels.name}} on node: {{$labels.node}}&#34;</span>
</code></pre></div><p><img src="http:///blantontechnology.com/img/firing-alert.png" alt="Firing Alert"></p>
<p>I&rsquo;m very new to Prometheus and alertmanager but these alerts are a good start.</p>
<h2 id="conclusion">Conclusion</h2>
<p>Learning how to create exporters opens up a whole world of possibilities. I already know the next step I want to take with this exporter&hellip; The Proxmox API provides some great info about SMART diagnostics for all the disks in Proxmox, this would be another great place to monitor so I can go ahead and have drives ready for my server if any errors start to arise.</p>

            </div>
        </div>
        <div id="comments" class="tile is-child box">
            <div class="content">
            <h2>Comments</h2>
            
                <button class="button is-primary" onclick="showComments()">Show Comments</button>
<script>
    var generatedComments = false

    function showComments() {
        var id =  2 ;
    
        if (id && !generatedComments)
        {
            generateComments(id)
        }
    }

    function generateComments(id) {
        generatedComments = true
        let url = "https://github.com/zbblanton/blog/issues/".concat(id);
        let api_url = "https://api.github.com/repos/zbblanton/blog/issues/".concat(id, "/comments");
        
        var commentsDiv = document.getElementById("comments");

        let xhr = new XMLHttpRequest();
        xhr.responseType = "json";
        xhr.open("GET", api_url);
        xhr.setRequestHeader("Accept", "application/vnd.github.v3.html+json");
        xhr.send();

        xhr.onload = function()
        {
            if (xhr.status != 200)
            {
            let errorText = document.createElement("p");
            errorText.innerHTML = "<i>Comments for this post yet are not opened yet (or you have GitHub scripts disabled).</i>";
            commentsDiv.appendChild(errorText);
            }
            else
            {
            let comments = xhr.response;

            let mainHeader = document.createElement("h2");
            mainHeader.innerHTML = "Comments: ".concat(comments.length);
            commentsDiv.appendChild(mainHeader);

            let issueLink = document.createElement("p");
            issueLink.innerHTML = "<i>You can leave a comment using this <a href='".concat(url, "'>GitHub issue</a>.</i>");
            commentsDiv.appendChild(issueLink);
            
            comments.forEach(function(comment)
            {
                let commentContent = document.createElement("div");
                commentContent.setAttribute('class', 'gh-comment')
                commentContent.innerHTML = "".concat(
                    "<div class='gh-header'>",
                        "<img src='", comment.user.avatar_url, "' />",
                        "<div style='margin:auto 0;'>",
                        "<b><a class='gh-username' href='", comment.user.html_url, "'>", comment.user.login, "</a></b>",
                        " commented at <em>", new Date(comment.created_at), "</em>",
                        "</div>",
                    "</div>",
                    "<div class='gh-body'>",
                        comment.body_html,
                    "</div>"
                );
                commentsDiv.appendChild(commentContent);
            });
            }
        };

        xhr.onerror = function()
        {
            let errorText = document.createElement("p");
            errorText.innerHTML = "<i>Some error loading comments.</i>";
            commentsDiv.appendChild(errorText);
        };
    }
  </script>
            
            </div>
        </div>
    </div>
    <div class="column is-3">
        <div class="card">
    <div class="card-content">
        <h1 class="title is-5">Tags</h1>
        <div class="tags">
        
            <span class="tag"><a href="http:///blantontechnology.com/tags/cloudflare">cloudflare</a></span>
        
            <span class="tag"><a href="http:///blantontechnology.com/tags/exporter">exporter</a></span>
        
            <span class="tag"><a href="http:///blantontechnology.com/tags/go">go</a></span>
        
            <span class="tag"><a href="http:///blantontechnology.com/tags/golang">golang</a></span>
        
            <span class="tag"><a href="http:///blantontechnology.com/tags/groovy">groovy</a></span>
        
            <span class="tag"><a href="http:///blantontechnology.com/tags/jenkins">jenkins</a></span>
        
            <span class="tag"><a href="http:///blantontechnology.com/tags/kubernetes">kubernetes</a></span>
        
            <span class="tag"><a href="http:///blantontechnology.com/tags/openfaas">openfaas</a></span>
        
            <span class="tag"><a href="http:///blantontechnology.com/tags/prometheus">prometheus</a></span>
        
        </div>          
    </div>
</div><br>
        <div class="card">
    <div class="card-content">
        <h1 class="title is-5">Recent posts</h1>
        
            <h1><a href="http:///blantontechnology.com/2020/creating-a-prometheus-metrics-exporter-for-zfs/">Creating a Prometheus Metrics Exporter for ZFS</a></h1>
            <time class="has-text-grey-light is-size-7">30 May 2020</time>
        
            <h1><a href="http:///blantontechnology.com/2020/creating-a-kubernetes-controller/">Creating a Kubernetes Controller</a></h1>
            <time class="has-text-grey-light is-size-7">11 May 2020</time>
        
            <h1><a href="http:///blantontechnology.com/2019/building-a-jenkins-pipeline-for-the-blog/">Building a Jenkins Pipeline for the Blog</a></h1>
            <time class="has-text-grey-light is-size-7">12 January 2019</time>
        
            <h1><a href="http:///blantontechnology.com/2019/setting-up-cloudflare-dynamic-dns-on-kubernetes/">Setting Up Cloudflare Dynamic Dns on Kubernetes</a></h1>
            <time class="has-text-grey-light is-size-7">7 January 2019</time>
        
            <h1><a href="http:///blantontechnology.com/2019/building-a-web-server-on-openfaas/">Building a Web Server on OpenFaaS</a></h1>
            <time class="has-text-grey-light is-size-7">6 January 2019</time>
        
    </div>
</div>
    <br>
                
  



<div class="card">
    <div class="card-content">
        <h1 class="title is-5">Related posts</h1>
      
      
            <h1><a href="http:///blantontechnology.com/2020/creating-a-kubernetes-controller/">Creating a Kubernetes Controller</a></h1>
            <time class="has-text-grey-light is-size-7">11 May 2020</time>
      
            <h1><a href="http:///blantontechnology.com/2019/setting-up-cloudflare-dynamic-dns-on-kubernetes/">Setting Up Cloudflare Dynamic Dns on Kubernetes</a></h1>
            <time class="has-text-grey-light is-size-7">7 January 2019</time>
      
            <h1><a href="http:///blantontechnology.com/2019/building-a-web-server-on-openfaas/">Building a Web Server on OpenFaaS</a></h1>
            <time class="has-text-grey-light is-size-7">6 January 2019</time>
      
    </div>
</div>

    
<br>
        <div class="card">
    <div class="card-content">
        <h1 class="title is-5">Archives</h1>
        
            <a href="http:///blantontechnology.com/archives/2020">2020</a> (2)<br>
        
            <a href="http:///blantontechnology.com/archives/2019">2019</a> (3)<br>
        
    </div>
</div>

    </div>
</div>


    </div>
</div>

<footer class="footer has-background-grey-darker has-text-white">
    <div class="content has-text-centered">
        <p>
            <span class="icon is-large"><a href="https://www.linkedin.com/in/zacharyblanton/" class="mysocial"><i class="fab fa-linkedin fa-3x"></i></a></span>&nbsp;&nbsp;
            <span class="icon is-large"><a href="https://github.com/zbblanton" class="mysocial"><i class="fab fa-github fa-3x"></i></a></span>&nbsp;&nbsp;
            <br><br>
            Copyright &copy; Blanton Technology 2020
        </p>
    </div>
</footer>

<script defer src="https://use.fontawesome.com/releases/v5.1.0/js/all.js"></script>
</body>
</html>
